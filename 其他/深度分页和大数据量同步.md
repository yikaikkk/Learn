# 深度分页和大数据量同步
最近的一个需求中，需要起一个离线的定时任务从别的服务的库里定时的拉数据回来，初步估计每次同步任务需要计算的数据量在200多万条。因此这就设计到一个大数据量同步的问题，同时由于数据量过大不可能一次性把所有数据都读取到内存中。这还设计到一个深度分页的问题。

## 深度分页
在mysql中，在传统的使用limit和offset来分页的方式中，当offset过大时，会导致每次都需要跳过前面的所有记录，导致查询时间增强。

因此采用基于主键游标的分页方式来优化，通过使用主键或唯一索引来进行游标分页。使用上一次查询结果的最后一条记录的主键作为下一次查询的起点。这种方式避免了使用 OFFSET，性能更优。
比如
```sql
SELECT * FROM users WHERE id > last_seen_id ORDER BY id LIMIT 10;
```
这种方法的优点是只需要定位到最后一条记录，而不需要跳过前面的记录。

## 大数据量同步
在同步数据时，考虑到数据量的问题，选择采用增量同步的方式，并且由于数据量巨大，无法全部读到内存中进行diff，所以选择在数据库中增加一个sync_status字段，每次同步开始时都把所有sync_status置为2，再把所有存在的更新为1，新增的也置为1，最后把2的数据删除，完成增量更新。