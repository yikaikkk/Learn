# 记一次由mysql性能导致的问题
## 背景
在新项目中，数据库和老服务的集群是一个集群，在今天上线了一个大数据量的同步任务以后导致老服务出现了读写不一致的问题

## 问题排查
首先排查mysql集群上的sql执行日志，发现有慢sql，对应找到sql对应的服务是上线的同步任务。但是同步任务和老服务的数据库并不是一个数据库。从而转而排查mysql自身的问题

对mysql的SLA指标进行分析发现，当同步任务执行时，mysql占用的cpu量快到50%，同时主从节点间的同步延迟达到了6s，而集群的策略采用的读写分离的策略，所有的读操作都是在从节点，所以会导致读写不一致的问题。

## 原理
来看下复制的流程：

1、主库收到更新命令，执行更新操作，生成 binlog;

2、从库在主从之间建立长连接；

3、主库 dump_thread 从本地读取 binlog 传送刚给从库；

4、从库从主库获取到 binlog 后存储到本地，成为 relay log（中继日志）；

5、sql_thread 线程读取 relay log 解析、执行命令更新数据。

不过 MySQL Replication 有个严重的缺点就是主从同步延迟。

因为数据是进行主从同步的，那么就会遇到主从同步延迟的情况。

为什么会出现主从延迟？

1、从库机器的性能比主库差；

2、从库的压力大；

大量查询放在从库上，可能会导致从库上耗费了大量的 CPU 资源，进而影响了同步速度，造成主从延迟。
3、大事务的执行；

有事务产生的时候，主库必须要等待事务完成之后才能写入到 binlog，假定执行的事务是一个非常大的数据插入，这些数据传输到从库，从库同步这些数据也需要一定的时间，就会导致从节点出现数据延迟。
4、从库的复制能力较差；

如果从库的复制能力，低于主库，那么在主库写入压力很大的情况下，就会造成从库长时间数据延迟的情况出现

## 复盘
导致本次case的原因就是从库的查询压力过大，耗费了大量的CPU资源，导致主从延迟

