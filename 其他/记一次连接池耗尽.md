# 记一次链接池耗尽
## 背景
最近在一个老项目重构的项目中，由于新项目会整合多个老项目的功能，所以会涉及到多个老项目上的数据，但是又由于老项目没有下线，所有需要定时将老项目数据库中的数据同步到新项目的数据库中。

## 功能设计
在对数据量级进行梳理后发现，数据得量级大概在200-300万之间，因此在同步时，一次读取完再处理不太现实，所以在实现时采用分页的方式，依次读取。同时在插入到新数据库表中时，发现如果使用mybatisplus的savebatch函数会格外的慢，调试发现他是一条一条处理的，所以采用手写sql的方式，手动实现批量插入。为了控制sql语句不超过jdbc的限制，控制数量在一次插入5000条。同时采用增量更新的方式，如果key存在就不插入，不存在再插入。最后使用事务包裹函数。

## 链接池耗尽优化
在查看日志时发现，链接池有时会出现耗尽的问题。发现如果对整个同步任务使用事务的话，整个事务会巨大，同时事务一直执行不完，会让链接无法释放，导致链接池耗尽的问题。

因此，将整个事务分割，对每页的更新和插入操作使用事务，而不是使用大事务

## 其他优化方式
优化代码和业务逻辑:
减少不必要的数据库或服务调用。 
将耗时操作进行异步处理，避免长时间占用连接。 