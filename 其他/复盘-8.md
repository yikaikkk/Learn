# Redis 大Key

## 背景
在复盘项目的时候，其中有一个部分涉及到行为审计，这一部分的数据是从日志的api导出得到的部分，经过数据的聚合分析，得到具体的行为分析日志，由于这一部分的数据巨大，并且可能会频繁读取，所以将这一部分数据放到了redis，但是因此导致一个大key问题

## 大Key

 对于string类型来说，一般情况下超过10KB则认为是大Key，对于set，zset，hash等类型来说，一般数据超过5000条即认为是大Key。当Redis存储的Key过大时，会对Redis的性能产生负面影响，如内存使用率过高、写入和读取数据的速度变慢等。

大键（Big Keys）在Redis中可能导致以下问题：

内存压力： 大键占用大量内存。如果Redis实例中存在大量大键，它们会迅速消耗系统的可用内存。这可能导致内存不足，Redis实例被迫使用交换空间（swapping），从而严重影响性能。

性能问题： 对大键的读取和写入操作通常会导致显著的内存分配和处理开销，因为Redis需要处理大数据结构。这会导致降低Redis的响应时间和整体性能，尤其是在同时处理多个大键的情况下。

持久性问题： 如果你使用Redis的持久性功能（如RDB快照或AOF日志），大键可能会导致备份和恢复操作变得更为耗时，因为需要处理大量数据。

备份问题： 在备份Redis数据时，大键可能会增加备份文件的大小，导致备份和恢复所需的存储和传输资源更多。

过期管理问题： 大键通常不会设置过期时间，因为过期检查可能导致性能问题。这意味着大键可能会一直存在，直到手动删除或替换为止，可能需要额外的管理工作。

慢查询问题： 如果你使用Redis的慢查询日志功能，大键可能会导致慢查询，因为对大键的操作通常会花费更多时间。

因此，大键在Redis中通常应该被避免，或者需要谨慎管理，以降低对内存和性能的不利影响。在实际应用中，应该考虑将大数据分割成更小的块，使用多个键来存储，以降低内存消耗和提高性能。合理使用Redis的数据结构和设置合适的数据过期策略也可以帮助管理大键。

## 解决方案
### 实际方案

大key拆分，将key中的数据进行水平拆分，按照一些字段和行为属性进行拆分，得到分类完的数据，再将每一类的key的数量进行限制，继续按照id拆分，每个id只能保存固定数量的值。最后将每一个类的所有key存入到mysql中作为索引。

### 其他优化措施

避免大key的生成和优化大key是关键的，因为它们可以显著影响Redis的性能。以下是一些方法来避免大key的生成和优化现有的大key：

避免大key的生成

数据模型设计： 在设计数据模型时，避免将大量数据存储在一个键中，特别是在字符串类型的键中。尽量将数据分散存储在多个键中，以降低每个键的大小。

数据分片： 将数据分散存储在多个Redis实例上，以分散负载和减小单个实例的内存占用。

使用合适的数据结构： 选择适当的数据结构以最小化内存占用。例如，使用有序集合代替列表，使用哈希表代替字符串等。

设置合理的TTL： 对于不再需要的数据，设置适当的TTL（生存时间），以确保数据会自动过期并被删除。

限制数据大小： 通过应用层面的限制，确保在Redis中存储的数据不会超过某个合理的阈值。

优化大keys

键的拆分： 如果已经存在大key，考虑将其拆分为多个较小的键。这有助于减小每个键的大小。

数据结构优化： 使用Redis的数据结构操作，如LTRIM（修剪列表）或HDEL（删除哈希表字段），以删除不再需要的数据。

数据压缩： 对于文本类型的大key，可以考虑使用压缩算法（snappy、LZ4J）来减小内存占用。

数据归档： 将不常用的数据归档到其他存储系统，以减小Redis的内存占用。

性能监控和分析： 定期监控Redis的性能和大key的数量，以及内存占用情况。这有助于识别性能问题并采取相应的措施。

定期维护： 制定定期维护策略，包括删除不再需要的数据和执行键的清理操作。

数据清理策略： 制定数据清理策略，包括定期删除过期键和无用数据。

合理设置内存限制： 在Redis的配置中，设置适当的内存限制，以防止大key占用过多内存。


