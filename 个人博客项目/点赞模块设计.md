# 点赞模块

## 点赞模块设计
参考文档-[点赞系统设计](https://www.51cto.com/article/800352.html)

点赞事件发生时，可能在一瞬间出现大量请求，所以如果直接将数据打到mysql中会导致mysql的数据承受问题，所以对于数据，先将其写入到缓存，同时采用mq来进行削峰。

### 缓存
使用Redis的两种数据结构来高效存储和查询数据：

- Set结构 : article_like_users:{articleId} 存储对某篇文章点赞的用户集合
  
  - 用途：快速判断用户是否已点赞
  - 操作：SADD、SREM、SISMEMBER
- Sorted Set结构 : article_like_count 存储所有文章的点赞数
  
  - 用途：存储文章ID和对应的点赞数，支持按点赞数排序
  - 操作：ZINCRBY、ZSCORE、ZREVERSERANGEWITHSCORES

同时在点赞+1的时候，会先判断是否点赞了，再进行加一，所以这是一个原子性的操作，但是如果直接操作看能产生并发问题，所以使用Lua脚本确保点赞/取消点赞操作的原子性：

```lua
if redis.call('sismember', KEYS[1], ARGV[1]) == 1 then return 0 end 
redis.call('zincrby', KEYS[2], 1, ARGV[2]) 
redis.call('sadd', KEYS[1], ARGV[1]) 
return 1
```

### 消息队列异步处理
每次点赞/取消点赞操作都会向RabbitMQ发送消息，用于同步到mysql

### 定时任务

最后设置一个定时任务，将mysql和redis中的数据进行对比，从而进行兜底